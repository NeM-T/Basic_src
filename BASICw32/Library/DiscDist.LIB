! ************************************************
!        確率分布ライブラリ（離散分布編）
! 二項分布  超幾何分布  ポアソン分布  負の二項分布
! ************************************************

! ********
! 二項分布
! ********

EXTERNAL FUNCTION LOG2C(n,r)
REM LOG2C = LOG2(COMB(n,r))
DECLARE NUMERIC i,t
LET t=0
FOR i=0 TO r-1
   LET t = t + LOG2(n-i) - LOG2(r-i)
NEXT i
LET LOG2C = t
END FUNCTION

EXTERNAL FUNCTION Binom(n,p,x)
REM 二項分布B(n,p)に従う確率変数Xの値がxである確率Pr(X＝x)
REM Binom = COMB(n,x) * p^x (1-p)^(n-x)
DECLARE EXTERNAL FUNCTION LOG2C
IF x<0 OR x>n OR FP(x)<>0 THEN
   LET Binom=0
ELSE
   LET Binom = 2^( LOG2C(n,x) + LOG2(p)*x + LOG2(1-p)*(n-x) )
END IF
END FUNCTION


EXTERNAL FUNCTION BinomLCum(n,p,x)  ! 2項分布の下側累積確率
REM 2項分布B(n,p)に従う確率変数Xの値がx以下である確率 Pr(X≦x)
DECLARE NUMERIC k,t
DECLARE NUMERIC u, LOG2_p, LOG2_q
DECLARE FUNCTION cumulative
IF x <= n * p THEN
   LET BinomLCum= cumulative(p,x)
ELSE
   LET BinomLcum = 1 - cumulative( 1-p, CEIL(n-x)-1)
END IF
FUNCTION cumulative(p,x)
   LET LOG2_p = LOG2(p)
   LET LOG2_q = LOG2(1-p)
   LET u = 0             ! 2項係数             
   FOR k = 0 TO x
      IF k=0 THEN 
         LET t = (1-p)^n       ! 累積確率
      ELSE 
         LET u = u + LOG2(n-k+1)-LOG2(k)
         LET t = t + 2^( u + k * LOG2_p + (n-k) * LOG2_q )
      END IF
   NEXT k
   LET Cumulative = t
END FUNCTION
END FUNCTION

EXTERNAL FUNCTION BinomUCum(n,p,x)  ! 2項分布の上側累積確率
REM 2項分布B(n,p)に従う確率変数Xの値がx以上である確率 Pr(x≦X)
DECLARE EXTERNAL FUNCTION BinomLCum
IF x <= n/2 THEN
   LET BinomUCum = 1- BinomLCum(n, p, CEIL(x)-1)
ELSE
   LET BinomUCum = BinomLCum(n, 1-p, n-x)
END IF      
END FUNCTION

EXTERNAL FUNCTION BinomLBound(n, p, a)  
REM Xが2項分布B(n,p)に従うとき，Pr(X＜k)≦a となる最大の整数k
DECLARE NUMERIC k,s
DECLARE NUMERIC t,u
DECLARE NUMERIC LOG2_p, LOG2_q
IF a<=0 THEN
   LET BinomLBound = 0
ELSEIF a<1 THEN 
   LET LOG2_p = LOG2(p)
   LET LOG2_q = LOG2(1-p)
   REM 確率値をMAXNUM/2倍して計算
   LET s = LOG2(MAXNUM)-1
   LET a = a * MAXNUM/2
   LET t = 2^ ( s + n * LOG2_q )       ! 累積確率
   LET u = s                           ! uは2項係数の対数
   LET k = 0
   DO WHILE t <= a AND k < n
      LET k = k + 1
      LET u = u + LOG2(n-k+1)-LOG2(k)
      LET t = t + 2^(u + k * LOG2_p + (n-k) * LOG2_q )
   LOOP
   LET BinomLBound = k
ELSE
   LET BinomLBound = n + 1
END IF 
END FUNCTION

EXTERNAL FUNCTION BinomUBound(n, p, a)  
REM Xが2項分布B(n,p)に従うとき，Pr(k＜X)≦aとなる最小の整数k
DECLARE EXTERNAL FUNCTION BinomLBound
LET BinomUBound = n - BinomLBound(n, 1-p, a)
END FUNCTION

! **********
! 超幾何分布
! **********

EXTERNAL FUNCTION HyperGeom(NN,M,n,x)
REM M個の不良品を含むNN個の製品からn個を非復元抽出したとき，不良品の個数がxである確率
DECLARE EXTERNAL FUNCTION LOG2C
IF x<0 OR x>M OR n-x<0 OR n-x>NN-M OR FP(x)<>0 THEN
   LET HyperGeom = 0
ELSE
   LET HyperGeom = 2^( LOG2C(M,x) + LOG2C(NN-M, n-x) - LOG2C(NN,n) )
END IF
END FUNCTION

EXTERNAL FUNCTION HyperGeomLCum(NN,M,n,x)
REM M個の不良品を含むN個の製品からk個を非復元抽出したとき，不良品の個数Xがx以下である確率 Pr(X≦x)
DECLARE EXTERNAL FUNCTION HyperGeom
DECLARE NUMERIC i,t
IF x<=n/2 THEN 
   LET t=0
   FOR i=0 TO x
      LET t = t + HyperGeom(NN,M,n,i)
   NEXT i
   LET HyperGeomLCum = t
ELSE
   DECLARE EXTERNAL FUNCTION HyperGeomUcum
   LET HyperGeomLcum = 1 - HyperGeomUCum(NN,M,n,INT(x)+1)
END IF
END FUNCTION

EXTERNAL FUNCTION HyperGeomUCum(NN,M,n,x)
REM M個の不良品を含むN個の製品からk個を非復元抽出したとき，不良品の個数Xがx以上である確率 Pr(x≦X)
DECLARE EXTERNAL FUNCTION HyperGeom
DECLARE NUMERIC i,t
IF x >= n/2 THEN
   LET t=0
   FOR i=n TO x STEP -1
      LET t = t + HyperGeom(NN,M,n,i)
   NEXT i
   LET HyperGeomUCum = t
ELSE
   DECLARE EXTERNAL FUNCTION HyperGeomLcum
   LET HyperGeomUcum = 1 - HyperGeomLCum(NN,M,n,CEIL(x)-1)
END IF
END FUNCTION

EXTERNAL FUNCTION HyperGeomLBound(NN, M, n, a)  
REM    Xが超幾何分布HyperGeom(NN,M,n)に従うとき，Pr(X＜k)≦a となる最大の整数k
REM i.e,                   Pr(X=0)+Pr(X=1)+…+Pr(X=k-1) ≦ a となる最大の整数k
DECLARE EXTERNAL FUNCTION HyperGeom
DECLARE NUMERIC i,t
IF a<=0 THEN
   LET HyperGeomLBound = 0
ELSEIF a<1 THEN 
   LET t=0
   LET i=-1
   DO WHILE t<=a AND i<M AND i<n
      LET i=i+1
      LET t= t + HyperGeom(NN, M, n, i)
   LOOP
   LET HyperGeomLBound = i
ELSE
   LET HyperGeomLBound = MIN(M,n)+1
END IF
END FUNCTION

EXTERNAL FUNCTION HyperGeomUBound(NN, M, n, a)  
REM    Xが超幾何分布HyperGeom(NN,M,n)に従うとき，Pr(k＜X)≦a となる最小の整数k
REM i.e,                   Pr(X=k+1)+Pr(X=k+2)+…+Pr(X=n)≦a となる最小の整数k
DECLARE EXTERNAL FUNCTION HyperGeom
DECLARE NUMERIC i,t
IF a<=0 THEN
   LET HyperGeomUBound = MIN(M,n)
ELSEIF a<1 THEN
   LET t=0
   LET i=MIN(M,n)+1
   DO WHILE t<=a AND i>=0
      LET i=i-1
      LET t= t + HyperGeom(NN, M, n, i)
   LOOP
   LET HyperGeomUBound = i
ELSE
   LET HyperGeomUBound = -1
END IF
END FUNCTION

! ************
! ポアソン分布
! ************

EXTERNAL FUNCTION Poisson(Lambda, x)  ! ポアソン分布の確率
IF x>=0 AND FP(x)=0 THEN
   LET Poisson = EXP(-lambda) * lambda ^ x / FACT(x)
ELSE
   LET Poisson = 0
END IF
END FUNCTION

EXTERNAL FUNCTION PoissonLCum(lambda, x) ! ポアソン分布の下側累積確率
REM ポアソン分布Po(lambda)に従う確率変数Xの値がx以下である確率 Pr(X≦x)
DECLARE NUMERIC k,sum,t
LET t = EXP(-lambda)
LET sum = 0
FOR k=0 TO x
   IF k>0 THEN  LET t = t * lambda / k
   LET sum = sum + t
NEXT k
LET PoissonLCum=sum
END FUNCTION
 
EXTERNAL FUNCTION PoissonUCum(lambda, x) ! ポアソン分布の上側累積確率
REM ポアソン分布Po(lambda)に従う確率変数の値Xがx以上である確率 Pr(x≦X)
DECLARE EXTERNAL FUNCTION PoissonLCum
LET PoissonUCum = 1 - PoissonLCum(lambda, CEIL(x)-1)
END FUNCTION
 
EXTERNAL FUNCTION PoissonLBound(lambda, a) 
REM Xがポアソン分布Po(lambda)に従うとき，Pr(X＜k)≦a となる最大の整数k
REM すなわち，           Pr(X＜k) ≦ a ,かつ，Pr(X≦k)＞ a となる整数k
DECLARE NUMERIC k,sum,t
IF a<1 THEN
   LET t = EXP(-lambda)
   LET sum = 0
   LET k = -1
   DO WHILE sum <=  a
      LET k = k + 1
      IF k>0 THEN LET t = t * lambda / k
      LET sum = sum + t
   LOOP
   LET PoissonLBound = k 
ELSE 
   LET PoissonLBound = MAXNUM
END IF
END FUNCTION

EXTERNAL FUNCTION PoissonUBound(lambda, a) 
REM Xがポアソン分布Po(lambda)に従うとき，Pr(k＜X)≦a となる最小の整数k
REM すなわち，                         Pr(X≦k)≧1-a となる最小の整数k
DECLARE EXTERNAL FUNCTION PoissonLbound
IF a<1 THEN
   LET PoissonUbound = PoissonLbound(lambda, 1-a)
ELSE ! a=1
   LET PoissonUbound = -1 
END IF   
END FUNCTION

!**************
! 負の二項分布
!**************

EXTERNAL FUNCTION NegBinom(r,p,x) ! 負の二項分布
REM 確率pの独立事象を反復するとき，r回成功するまでの失敗回数
REM Binom = COMB(x+r-1,x) * p^r * (1-p)^x
DECLARE EXTERNAL FUNCTION LOG2C
IF x<0 OR FP(x)<>0 THEN
   LET NegBinom=0
ELSE
   LET NegBinom = 2^( LOG2C(x+r-1,x) + LOG2(p)*r + LOG2(1-p)*x )
END IF
END FUNCTION

EXTERNAL FUNCTION NegBinomLCum(r,p,x)
REM 負の二項分布の値がx以下である確率 Pr(X≦x)
DECLARE EXTERNAL FUNCTION NegBinom
DECLARE NUMERIC i,t
LET t=0
FOR i=0 TO x
   LET t = t + NegBinom(r,p,i)
NEXT i
LET NegBinomLCum = t
END FUNCTION

EXTERNAL FUNCTION NegBinomUCum(r,p,x)
REM 負の二項分布の値がx以上である確率 Pr(x≦X)
DECLARE EXTERNAL FUNCTION NegBinomLCum
LET NegBinomUCum = 1 - NegBinomLCum(r,p,CEIL(x)-1)
END FUNCTION

EXTERNAL FUNCTION NegBinomLBound(r, p, a)  
REM    Xが負の二項分布NegBinom(r,p)に従うとき，Pr(X＜k)≦a となる最大の整数k
REM すなわち，                 Pr(X＜k) ≦ a ,かつ，Pr(X≦k)＞ a となる整数k
DECLARE EXTERNAL FUNCTION NegBinom
DECLARE NUMERIC i,t
IF a<=0 THEN
   LET NegBinomLBound = 0
ELSEIF a<1 THEN
   LET t=0
   LET i=-1
   DO WHILE t<=a 
      LET i=i+1
      LET t= t + NegBinom(r, p, i)
   LOOP
   LET NegBinomLBound = i
ELSE
   LET NegBinomLBound = MAXNUM
END IF
END FUNCTION

EXTERNAL FUNCTION NegBinomUBound(r, p, a)  
REM    Xが負の二項分布NegBinom(r,p)に従うとき，Pr(k＜X)≦a となる最小の整数k
REM すなわち，                                 Pr(X≦k)≧1-a となる最小の整数k
DECLARE EXTERNAL FUNCTION NegBinomLbound
IF a<1 THEN
   LET NegBinomUbound = NegBinomLbound(r, p, 1-a)
ELSE ! a=1
   LET NegBinomUbound = -1 
END IF   
REM  Pr(X≦k)＞1-a となる最小の整数k，すなわち，
REM  Pr(k＜X)＜a となる最小の整数kを求めているので，
REM  確率値が誤差なく求まる場合でも誤差を持つことがある。
END FUNCTION
